package controller;

import java.awt.Color;
import java.awt.Component;
import java.awt.GridLayout;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.*;
import java.net.*;
import common.*;
import view.*;
import javax.swing.*;
import java.util.*;
public class ClientThread extends Thread {
	
	private Socket s;
	
	public Socket getS() {
		return s;
	}

	public void setS(Socket s) {
		this.s = s;
	}

	public ClientThread(Socket s){
		this.s = s;
	}
	
	public void run(){
		
		ObjectInputStream ois;
		try {
			while(true){
				ois = new ObjectInputStream(s.getInputStream());
				Message m=(Message)ois.readObject();
				MainInterface main = ManageChat.getView("1");
				if (m.getMesType().equals(MessageType.onLine_Friend)) {
					//update friend list
					//System.out.println("new user is:" + m.getCon());
					//MainInterface main = ManageChat.getView("1");
					if (main != null) {
						main.updateOnlineFriendList(m.getCon());
					}
				} else if (m.getMesType().equals(MessageType.offLine_Friend)) {
					//MainInterface main = ManageChat.getView("1");
					if (main != null) {
						main.updateOfflineFriendList(m.getCon());
					}
				}
				else if(m.getMesType().equals(MessageType.returnRelation))
				{
					System.out.println("receive list");
					ArrayList<String> OnlineFriend;
					
					JPanel friendPanel = main.getFriendPanel();
					JScrollPane friendlist = main.getFriendlist();
					HashMap<String,JLabel> friend = main.getFriend();
					ArrayList<String> relation = m.getFriendList();
					String[] friendArray = main.getFriendArray();
					int total_relation = relation.size();
					OnlineFriend = RelationManage.getOnlineFriend();
					int cnt_onlineFriend = OnlineFriend.size();
					friendPanel = new JPanel();		
					friendlist = new JScrollPane(friendPanel);
					friend = new HashMap<String, JLabel>();
					
					friendArray = new String[total_relation];
					for(int i = 0; i < total_relation; i++){
						String friend_i = relation.get(i);
						friendArray[i] = friend_i;
						friend.put(friend_i, new JLabel(friend_i));

						
						((Component) friend.get(friend_i)).addMouseListener(new MouseAdapter(){
							@Override
							public void mouseClicked(MouseEvent e) {
								if(e.getClickCount() == 2){
									String friendID = ((JLabel)e.getSource()).getText();
									System.out.println("wish to talk to friend " + friendID);
									main.newChatBox(friendID);
								}
							}

						});
						friendPanel.add((Component) friend.get(friend_i));
					}
					for(int i = 0; i < cnt_onlineFriend; i++) {
						((Component) friend.get(friendArray[i])).setForeground(Color.GREEN);
					}
				}
				else{
					System.out.println("Sender: " + m.getSender()+"to");
					System.out.println("Getter: " + m.getGetter());
					System.out.println("Message:"+m.getCon()+"\n");
					
					//MainInterface main= ManageChat.getView("1");
					
					System.out.println(main.getTarget());
					if(main.getTarget().equals(m.getSender()))
					{
						
						main.showMessage(m);
					}
					else{
						String s=ManageChat.getCon(m.getSender());
						String info=m.getSender()+" to "+m.getGetter()+" :"+m.getCon()+"\r\n";
						if(s == null)
							s = info;
						else
							s = s + info;
						ManageChat.addCon(m.getSender(), s);
						HashMap map = main.getFriend();
						((Component) map.get(m.getSender())).setForeground(Color.RED);
						((Component) map.get(m.getSender())).addMouseListener(new MouseAdapter() {
							@Override
							public void mouseClicked(MouseEvent e) {
								if(e.getClickCount() == 2){
									((Component) map.get(m.getSender())).setForeground(Color.GREEN);
								}
							}
						});
						
					}
				}
			}
				
		}catch (Exception e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
		}
			
		
	}
	
}
	
	


